# 실버바인 서버엔진 2의 파이버

## 개념
실버바인 서버엔진 2에서는 스택풀 코루틴(stackful coroutine)을 폭넓게 사용합니다.
스택풀 코루틴에는 여러가지 다른 이름이 있는데, 실버바인 서버엔진 2에서는 **파이버**(`Fiber`)라고 부릅니다.

## 용도
실버바인 서버엔진 2에서는
로직 프로그래머에게 멀티스레드나 비동기 I/O 프로그래밍의 부담을 지우지 않으면서
서버 프로세스 내부의 공유 상태를 안전하게 조작하기 위한 목적으로 파이버를 사용합니다.
DB 접근 등 I/O 대기가 필요한 동작은 파이버를 통해서만 실행할 수 있습니다.

## 구현
.NET Framework는 스택풀 코루틴을 지원하지 않지만,
async/await을 잘 활용해서, **실행 종료를 기다릴 수 있는 async 루틴**들을 연결해서 하나의 실행 흐름으로 느껴지도록 만들었습니다.
그리고 여러 파이버가 공유 상태를 안전하게 변경할 수 있도록 하기 위해, 모든 파이버는 **메인 스레드**에서 실행됩니다.

파이버로 실행되는 코드가 메인 스레드를 떠나지 않고 안전하게 실행되게 하기 위해서 지켜야 하는 규칙들이 있습니다.
규칙을 어기면 파이버 전환이 비정상적으로 일어나고, 그 이후의 엔진 호출에서 EngineErrorException이 발생합니다.
비정상적인 파이버 전환이 일어난 시점 **이후에** 예외가 발생하기 때문에, 무엇을 잘못했는지 찾아내기가 매우 어렵습니다.
반드시 아래의 규칙들을 이해하시고 코드를 주의깊게 작성하셔야 합니다.
 
## 규칙: async void 금지
C# async 함수는 세 가지 종류의 리턴값 중 하나를 가질 수 있습니다.
1. async Task: 실행 완료를 기다릴 수 있고, 리턴값 없음
2. async Task&lt;T>: 실행 완료를 기다릴 수 있고, 리턴값 있음
3. async void: 실행 완료를 기다릴 수 없음
 
async void를 쓰면 파이버로 제대로 실행할 수 없습니다. 소스코드를 전체검색해서 async void가 하나라도 들어있다면 심각한 문제가 있는 것이라고 보셔도 됩니다.
 
## 규칙: 리턴되는 Task를 무시하면 안됨
파이버를 구성할 async 루틴들이 리턴하는 Task를 무시하면, async void 함수를 호출했을 때와 비슷한 문제가 발생합니다.
리턴된 Task는 반드시 어디에선가 await되어야 합니다. 받은 Task를 그 자리에서 바로 await하거나, 아니면 바로 리턴함으로써 나를 호출한 함수가 그 Task를 기다릴 수 있도록 하세요.
 
## 규칙: 세션핸들러에서는 null을 리턴해도 됨
ISessionHandler 보시면 모든 메서드에 Task가 달려 있지요.
파이버 안에서 실행되는 친구들입니다.
따라서 async Task로 만들어야 하는데요,
세션핸들러에 대해서는 엔진에서 특수 처리를 해놓았기 때문에,
리턴되는 Task가 null이면 await하지 않고 바로 진행하게 되어 있습니다.
 
모바일 게임이라면 클라이언트가 보낸 모든 요청에서 DB에 접근해야 하니까 언제나 실행 중지/재개가 필요하지만,
MMORPG라면 DB에 접근하는 요청보다는 메모리에서 처리가 끝나는 요청들이 더 많을 것입니다.
그런 요청 하나하나마다 파이버를 중지/재개하는 비용이 걱정된다면 그냥 async 키워드를 떼고, Task에는 null을 리턴해도 됩니다.

## 규칙: 다른 라이브러리가 리턴한 Task에는 .ToFiberTask() 를 부르자
[실버바인 서버엔진 2의 파이버](fiber_in_silvervine_server_engine.md)에서,
모든 파이버가 메인 스레드에서 실행된다고 말씀드렸습니다.
그런데 실버바인 서버엔진 2가 아닌 다른 .NET 태스크 라이브러리는, `Task`를 사용해서 `await`하고 나면
그 이후에는 스케줄러를 통해서 다른 스레드로 바뀌어 실행되기 때문에,
정상적으로 실행하기 어렵습니다.

메인 스레드로 돌아오려면 리턴된 `Task`에 `.ToFiberTask()`를 호출한 결과에 `await`하게 만들면 됩니다.

### 주의가 필요한 라이브러리의 예
 * `~Async`:<br>
 ![AWS S3 SDK](../img/thirdparty_async_library_example.png)<br>
 이 예는 AWS S3 SDK에서 가져왔습니다. `PutObjectAsync(...)`의 리턴 타입이 `Task<T>`인데,
 이것을 `await`하면 다른 스레드로 바뀌어 버립니다.
 리턴된 `Task<T>`에 `.ToFiberTask()`를 호출한 것을 `await` 하여, 메인 스레드로 돌아오도록 합시다.
 